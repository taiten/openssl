From: Sebastian Andrzej Siewior <sebastian@breakpoint.cc>
Date: Fri, 2 Apr 2021 21:45:37 +0200
Subject: Configurations: Add -latomic on Linux

A build of alpha13 fails on armel (arm-linux-gnueabi, armv5te) POWER
32bit, mipsel (32bit MIPS little endian) and m68k failed to link due to
missing __atomic_fetch_or_8() in CRYPTO_atomic_or() among other calls.

Some platforms require to link against libatomic in order to provide
these functions while other can inline the needed bits.

Add -latomic to every Linux port. On armhf (arm-linux-gnueabihf,
armv7-a) resulted with no extra linking against libatomic with gcc-10.
With gcc-8 it linked against libatomic but was not needed because the
function was inlined.

One alternative would be to add it to the platforms that need it (either
in the generic template for mips and powerpc) or in our Debian rules.
Another alternative would be to use a compile test at configure time for
an autodetect.
I'm not aware of any query interface for this.

Signed-off-by: Sebastian Andrzej Siewior <sebastian@breakpoint.cc>
---
 Configurations/10-main.conf | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/Configurations/10-main.conf b/Configurations/10-main.conf
index b27a60cf3923..343b0f51eeb4 100644
--- a/Configurations/10-main.conf
+++ b/Configurations/10-main.conf
@@ -706,6 +706,7 @@ my %targets = (
         inherit_from     => [ "linux-generic32" ],
         asm_arch         => 'ppc32',
         perlasm_scheme   => "linux32",
+        ex_libs          => add("-latomic"),
         lib_cppflags     => add("-DB_ENDIAN"),
     },
     "linux-ppc64" => {
@@ -784,6 +785,7 @@ my %targets = (
         cxxflags         => add("-mabi=32"),
         asm_arch         => 'mips32',
         perlasm_scheme   => "o32",
+        ex_libs          => add("-latomic"),
     },
     # mips32 and mips64 below refer to contemporary MIPS Architecture
     # specifications, MIPS32 and MIPS64, rather than to kernel bitness.
@@ -926,6 +928,7 @@ my %targets = (
         cflags           => add("-mcpu=v8"),
         cxxflags         => add("-mcpu=v8"),
         lib_cppflags     => add("-DB_ENDIAN -DBN_DIV2W"),
+        ex_libs          => add("-latomic"),
         asm_arch         => 'sparcv8',
         perlasm_scheme   => 'void',
     },
@@ -935,6 +938,7 @@ my %targets = (
         inherit_from     => [ "linux-generic32" ],
         cflags           => add("-m32 -mcpu=ultrasparc -Wa,-Av8plus"),
         cxxflags         => add("-m32 -mcpu=ultrasparc -Wa,-Av8plus"),
+        ex_libs          => add("-latomic"),
         lib_cppflags     => add("-DB_ENDIAN -DBN_DIV2W"),
         asm_arch         => 'sparcv9',
         perlasm_scheme   => 'void',
@@ -945,6 +949,7 @@ my %targets = (
         cflags           => add("-m64 -mcpu=ultrasparc"),
         cxxflags         => add("-m64 -mcpu=ultrasparc"),
         lib_cppflags     => add("-DB_ENDIAN"),
+        ex_libs          => add("-latomic"),
         bn_ops           => "BN_LLONG RC4_CHAR",
         asm_arch         => 'sparcv9',
         perlasm_scheme   => 'void',
